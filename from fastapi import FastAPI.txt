from fastapi import FastAPI
import random
from fastapi.responses import JSONResponse

app = FastAPI()

# âœ… 1ï¸âƒ£ ê¸°ë³¸ ë¼ìš°íŠ¸ (í™ˆ)
@app.get("/")
def read_root():
    return JSONResponse(content={"message": "ë¡œë˜ ë²ˆí˜¸ ì¶”ì²œ APIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"}, ensure_ascii=False)

# âœ… 2ï¸âƒ£ ëœë¤ ë¡œë˜ ë²ˆí˜¸ ì¶”ì²œ
@app.get("/lotto")
def get_lotto_numbers():
    numbers = random.sample(range(1, 46), 6)  # 1~45 ì¤‘ 6ê°œ ëœë¤ ì„ íƒ
    numbers.sort()  # ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    return JSONResponse(content={"lotto_numbers": numbers}, ensure_ascii=False)

# âœ… 3ï¸âƒ£ ë¨¸ì‹ ëŸ¬ë‹ ê¸°ë°˜ ì˜ˆì¸¡
@app.get("/predict")
def predict_lotto_numbers():
    # ğŸ“Œ 1. ê³¼ê±° ë¡œë˜ ë°ì´í„° ë¡œë“œ
    df = pd.read_csv("ë¡œë˜ë‹¹ì²¨ë²ˆí˜¸.csv")  # ë¡œë˜ ë°ì´í„° íŒŒì¼ í•„ìš”

    # ğŸ“Œ 2. í•„ìš”í•œ ë°ì´í„° ì „ì²˜ë¦¬
    df = df[["ë²ˆí˜¸1", "ë²ˆí˜¸2", "ë²ˆí˜¸3", "ë²ˆí˜¸4", "ë²ˆí˜¸5", "ë²ˆí˜¸6"]]  # ë‹¹ì²¨ë²ˆí˜¸ë§Œ ì„ íƒ
    X = df.shift(1).dropna()  # ì´ì „ íšŒì°¨ ë°ì´í„° ì‚¬ìš©
    y = df.drop(df.index[0])  # í˜„ì¬ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸

    # ğŸ“Œ 3. ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ í•™ìŠµ
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    model = XGBClassifier()
    model.fit(X_train, y_train)

    # ğŸ“Œ 4. ì˜ˆì¸¡í•  ìƒˆë¡œìš´ ì…ë ¥ ë°ì´í„° ìƒì„±
    latest_numbers = df.iloc[-1].values.reshape(1, -1)
    predicted = model.predict(latest_numbers)[0]

    return {"predicted_lotto_numbers": list(predicted)}